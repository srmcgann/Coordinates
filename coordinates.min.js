var cacheItem;let S=Math.sin,C=Math.cos,Rn=Math.random,scratchCanvas=document.createElement("canvas"),sctx=scratchCanvas.getContext("2d",{alpha:!0,antialias:!0,desynchronized:!0,premultipliedAlpha:!1}),scratchImage=new Image,moduleBase="https://srmcgann.github.io/Coordinates",cache={objFiles:[],customShapes:[],textures:[],geometry:[],texImages:[]},Renderer=e=>{var a,r=0,o=0,t=0,i=1920,n=1080,s=0,c=0,l=0,$=2e3,f=!0,p=10,m=!1,d=.2,u=!1,h=0,_={mode:"webgl2",options:{alpha:!0,antialias:!0,desynchronized:!0,premultipliedAlpha:!1}},g=[],v=[],y=[];void 0!==e&&Object.keys(e).forEach((a,g)=>{switch(a.toLowerCase()){case"width":i=e[a];break;case"height":n=e[a];break;case"alpha":u=e[a];break;case"x":r=e[a];break;case"y":o=e[a];break;case"z":t=e[a];break;case"roll":s=e[a];break;case"pitch":c=e[a];break;case"yaw":l=e[a];break;case"fov":$=e[a];break;case"clearcolor":h=e[a];break;case"attachTobody":f=!!e[a];break;case"exportgpuspecs":m=!!e[a];break;case"margin":p=e[a];break;case"ambientlight":d=e[a];break;case"context":_.mode=e[a].mode,_.options=e[a].options}});let E=document.createElement("canvas"),b=E.getContext(_.mode,_.options);E.width=i,E.height=n;let x=_[0];console.log(`GLSL version: ${b.getParameter(b.SHADING_LANGUAGE_VERSION)}`),m&&getParams(b),"2d"===x||b.viewport(0,0,E.width,E.height),f&&(E.style.display="block",E.style.position="absolute",E.style.left="50vw",E.style.top="50vh",E.style.transform="translate(-50%, -50%)",E.style.border="1px solid #fff3",E.style.background="#000",document.body.appendChild(E)),window.addEventListener("resize",a=e=>{var a,r=document.body,o=0!==E.width?E.height/E.width:1;r.clientHeight/r.clientWidth>o?(E.style.width=`${(a=r.clientWidth)-2*p}px`,E.style.height=`${a*o-2*p}px`):(E.style.height=`${(a=r.clientHeight)-2*p}px`,E.style.width=`${a/o-2*p}px`)}),a();var A={c:E,ctx:b,contextType:x,t:0,alpha:u,width:i,height:n,x:r,y:o,z:t,roll:s,pitch:c,yaw:l,fov:$,ready:!1,ambientLight:d,pointLights:v,pointLightCols:y,spriteQueue:g};A["2d"==x?"ctx":"gl"]=b;var T=A;let I=()=>{"2d"===x?E.width=T.c.width:(b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT),b.clear(b.DEPTH_BUFFER_BIT))};T.Clear=I;let P=async(e,a=!1)=>{var r,o=e.shader.datasets[e.datasetIdx],t=o.program;if(void 0!==e?.shader){if(!a&&(e.isSprite||e.isLight&&e.pointLightShowSource))T.spriteQueue=[e,...T.spriteQueue];else{b.useProgram(t),"video"==e.textureMode&&BindImage(b,o.video,o.texture,e.textureMode,T.t,e.map),b.useProgram(t),b.uniform1i(o.locTexture,o.texture),b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,o.texture),b.uniform1i(o.locPointLightCount,T.pointLights.length);var i=[],n=[];T.pointLights.map(e=>{i=[...i,e.x,e.y,e.z,e.lum],HexToRGB(e.color),n=[...n,...HexToRGB(e.color),1]}),i.length&&(b.uniform4fv(o.locPointLights,i),b.uniform4fv(o.locPointLightCols,n));var s=T.ambientLight;o.optionalLighting.map(e=>{"ambientLight"===e.name&&(s=e.value)}),o.optionalUniforms.map(async a=>{if("object"==typeof a?.loc)switch(b[a.dataType](a.loc,a.value*(a.name,1)),b.uniform1f(a.locFlatShading,a.flatShading?1:0),a.name){case"reflection":b.activeTexture(b.TEXTURE1),"video"==a.textureMode&&BindImage(b,a.video,a.refTexture,a.textureMode,T.t,a.map),b.useProgram(t),b.uniform1i(a.locRefTexture,1),b.bindTexture(b.TEXTURE_2D,a.refTexture),b.uniform1f(a.locRefOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0);break;case"phong":a.locPhongTheta=b.getUniformLocation(o.program,"phongTheta"),b.uniform1f(a.locPhongTheta,a.theta)}}),b.uniform1f(o.locT,T.t),b.uniform1f(o.locColorMix,e.colorMix),b.uniform1f(o.locIsSprite,e.isSprite),b.uniform1f(o.locIsLight,e.isLight),b.uniform1f(o.locAlpha,e.alpha),b.uniform3f(o.locColor,...HexToRGB(e.color)),b.uniform1f(o.locAmbientLight,s/8),b.uniform2f(o.locResolution,T.width,T.height),b.uniform3f(o.locCamPos,T.x,T.y,T.z),b.uniform3f(o.locCamOri,T.roll,T.pitch,T.yaw),b.uniform3f(o.locGeoPos,e.x,e.y,e.z),b.uniform3f(o.locGeoOri,e.roll,e.pitch,e.yaw),b.uniform1f(o.locFov,T.fov),b.uniform1f(o.locEquirectangular,e.equirectangular?1:0),b.uniform1f(o.locRenderNormals,0),b.bindBuffer(b.ARRAY_BUFFER,e.uv_buffer),b.bufferData(b.ARRAY_BUFFER,e.uvs,b.STATIC_DRAW),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,e.UV_Index_Buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,e.uvIndices,b.STATIC_DRAW),b.vertexAttribPointer(o.locUv,2,b.FLOAT,!1,0,0),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null),b.bindBuffer(b.ARRAY_BUFFER,null),b.bindBuffer(b.ARRAY_BUFFER,e.normalVec_buffer),b.bufferData(b.ARRAY_BUFFER,e.normalVecs,b.STATIC_DRAW),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,e.nVecIndices,b.STATIC_DRAW),b.vertexAttribPointer(o.locNormalVec,3,b.FLOAT,!0,0,0),b.enableVertexAttribArray(o.locNormalVec),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null),b.bindBuffer(b.ARRAY_BUFFER,null),e?.vertices?.length&&(b.bindBuffer(b.ARRAY_BUFFER,e.vertex_buffer),b.bufferData(b.ARRAY_BUFFER,e.vertices,b.STATIC_DRAW),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,e.vIndices,b.STATIC_DRAW),b.bindBuffer(b.ARRAY_BUFFER,e.vertex_buffer),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),o.locPosition=b.getAttribLocation(o.program,"position"),b.vertexAttribPointer(o.locPosition,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(o.locPosition),b.drawElements(b.TRIANGLES,e.vertices.length/3|0,b.UNSIGNED_INT,0),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null),b.bindBuffer(b.ARRAY_BUFFER,null)),b.uniform1f(o.locRenderNormals,e.showNormals?1:0),e.showNormals&&e?.normals?.length&&(b.bindBuffer(b.ARRAY_BUFFER,e.normal_buffer),b.bufferData(b.ARRAY_BUFFER,e.normals,b.STATIC_DRAW),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,e.Normal_Index_Buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,e.nIndices,b.STATIC_DRAW),b.vertexAttribPointer(o.locNormal,3,b.FLOAT,!1,0,0),o.locNormal=b.getAttribLocation(o.program,"normal"),b.bindBuffer(b.ARRAY_BUFFER,e.normal_buffer),b.bufferData(b.ARRAY_BUFFER,e.normals,b.STATIC_DRAW),b.enableVertexAttribArray(o.locNormal),b.drawElements(b.LINES,e.normals.length/3|0,b.UNSIGNED_INT,0),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null),b.bindBuffer(b.ARRAY_BUFFER,null))}}};return T.Draw=P,T},DestroyViewport=e=>{e.remove()},LoadOBJ=async(e,a,r,o,t,i,n,s,c=!0)=>{var l,$,f,p,m={vertices:[],normals:[],uvs:[]};if((cacheItem=cache.objFiles.filter(a=>a.url==e)).length)m=cacheItem[0].ret;else{var d=[],u=[],h=[],_=[];await fetch(e).then(e=>e.text()).then(e=>{e.split("\n").forEach(e=>{var a=e.split(" "),r=a[0];switch(r){case"v":a.shift(),d=[...d,a.map(e=>+e)];break;case"vt":a.shift(),h=[...h,a.map(e=>+e)];break;case"vn":a.shift(),u=[...u,a.map(e=>+e)];break;case"f":a.shift(),_=[..._,a.map(e=>e)]}}),_.map(e=>{var a,r,o,t=[],i=[],n=[];e.map(e=>{var s=e.split("/");switch(s.length){case 1:t=[...t,d[(a=s[0])-1]];break;case 2:a=s[0],r=s[1],t=[...t,d[a-1]],i=[...i,h[r-1]];break;case 3:a=s[0],r=s[1],o=s[2],t=[...t,d[a-1]],i=[...i,h[r-1]],n=[...n,u[o-1]]}});var s=t[0][0],c=t[0][1],$=t[0][2],f=t[1][0],p=t[1][1],_=t[1][2],g=t[2][0],v=t[2][1],y=t[2][2],E=n[0][0],b=n[0][1],x=n[0][2],A=n[1][0],T=n[1][1],I=n[1][2],P=n[2][0],F=n[2][1],L=n[2][2];if(4==t.length)var B=t[3][0],U=t[3][1],N=t[3][2],w=n[3][0],M=n[3][1],k=n[3][2];switch(t.length){case 3:l=[],n.map((e,a)=>{l=[...l,[s,c,$,s+E,c+b,$+x],[f,p,_,f+A,p+T,_+I],[g,v,y,g+P,v+F,y+L]]}),n=l,m.vertices=[...m.vertices,...t[0],...t[1],...t[2]],i.length&&void 0!==i[0]&&(m.uvs=[...m.uvs,...i[0],...i[1],...i[2]]),n.length&&void 0!==n[0]&&(m.normals=[...m.normals,...n[0],...n[1],...n[2]]);break;case 4:l=[],n.map((e,a)=>{l=[...l,[s,c,$,s+E,c+b,$+x],[f,p,_,f+A,p+T,_+I],[g,v,y,g+P,v+F,y+L],[B,U,N,B+w,U+M,N+k]]}),n=l,m.vertices=[...m.vertices,...t[0],...t[1],...t[2],...t[2],...t[3],...t[0]],i.length&&(m.uvs=[...m.uvs,...i[0],...i[1],...i[2],...i[2],...i[3],...i[0]]),n.length&&(m.normals=[...m.normals,...n[0],...n[1],...n[2],...n[2],...n[3],...n[0]])}})}),cache.objFiles=[...cache.objFiles,{url:e,ret:m}]}for(var g=0;g<m.uvs.length;g+=2)m.uvs[g+1]=1-m.uvs[g+1];for(var g=0;g<m.normals.length;g+=3)m.normals[g+1]=-m.normals[g+1];for(var g=0;g<m.vertices.length;g+=3){$=m.vertices[g+0];var v=[$,f=m.vertices[g+1],p=m.vertices[g+2]];n&&(v=R(...v,{roll:0,pitch:n,yaw:0})),s&&(v=R(...v,{roll:0,pitch:0,yaw:s})),i&&(v=R(...v,{roll:i,pitch:0,yaw:0})),m.vertices[g+0]=v[0],m.vertices[g+1]=v[1],m.vertices[g+2]=v[2];for(var y=2;y--;){var E=y?2*g:2*g+3;$=m.normals[E+0];var v=[$,f=m.normals[E+1],p=m.normals[E+2]];n&&(v=R(...v,{roll:0,pitch:n,yaw:0})),s&&(v=R(...v,{roll:0,pitch:0,yaw:s})),i&&(v=R(...v,{roll:i,pitch:0,yaw:0})),m.normals[E+0]=v[0],m.normals[E+1]=v[1],m.normals[E+2]=v[2]}}return m},Q=(e,a,r,o,t=700)=>[o.width/2+e/r*t,o.height/2+a/r*t],R=(e,a,r,o,t=!1)=>{var i,n,s=Math,c=s.hypot,l=s.atan2,$=o.roll,f=o.pitch,p=o.yaw;if(e=S(i=l(e,a)+$)*(n=c(e,a)),a=C(i)*n,e=S(i=l(e,r)+p)*(n=c(e,r)),r=C(i)*n,a=S(i=l(a,r)+f)*(n=c(a,r)),r=C(i)*n,t){var m=o.x,d=o.y,u=o.z;e+=m,a+=d,r+=u}return[e,a,r]},LoadGeometry=async(e,a)=>{let r=e.gl;var o,t,i,n,s,c,l,$,f,p,m,d,u,h,_,g,v,y,E,b,x,A,T=!1,I=0,P=0,F=0,L=0,B=0,U=0,N=1,w=1,M=1,k=16,O=40,D="",g="",z=1,V=!1,G=0,H=0,Y=3355443,X=.1,W=!1,K=!1,q=!1,j="",Z=!0,J=0,ee=0,ea=1,er="image",eo=!1,et=!1,ei=1,en=1,es={};Object.keys(a=structuredClone(a)).forEach((e,r)=>{"pointlightshowsource"===e.toLowerCase()&&(eo=!!a[e])}),Object.keys(a).forEach((e,r)=>{switch(e.toLowerCase()){case"x":I=a[e];break;case"y":P=a[e];break;case"z":F=a[e];break;case"roll":L=a[e];break;case"pitch":B=a[e];break;case"yaw":U=a[e];break;case"shapetype":"point light"===(v=a[e].toLowerCase())&&(j=eo?`${moduleBase}/resources/stars/star.png`:"");break;case"size":z=a[e];break;case"subs":G=a[e];break;case"equirectangular":W=!!a[e];break;case"flipnormals":K=!!a[e];break;case"shownormals":q=!!a[e];break;case"sphereize":H=a[e];break;case"objx":o=a[e];break;case"objy":t=a[e];break;case"objz":i=a[e];break;case"objroll":n=a[e];break;case"objpitch":s=a[e];break;case"objyaw":c=a[e];break;case"scalex":N=a[e];break;case"scaley":w=a[e];break;case"scalez":M=a[e];break;case"name":g=a[e];break;case"color":Y=a[e];break;case"colormix":X=a[e];break;case"exportshape":T=!!a[e];break;case"url":D=a[e];break;case"map":j=a[e];break;case"rows":k=a[e];break;case"disabledepthtest":et=a[e];break;case"cols":O=a[e];break;case"muted":Z=!!a[e];break;case"lum":ei=a[e];break;case"alpha":en=a[e];break;case"issprite":J=a[e]?1:0;break;case"islight":ee=a[e]?1:0;break;case"playbackspeed":ea=a[e];break;case"averagenormals":V=!!a[e];break;default:es[e]=a[e]}}),H&&(V=!0);var ec=[],el=[],e$=[],ef=[],ep=!1;if(-1!=v.indexOf("custom shape"))ev=D,eR=`${v} ${g} (${D})`;else if(eR=`${v}_${G}`,G<5&&eR)switch(eR){case"tetrahedron_0":case"tetrahedron_1":case"tetrahedron_2":case"tetrahedron_3":case"tetrahedron_4":case"cube_0":case"cube_1":case"cube_2":case"cube_3":case"cube_4":case"octahedron_0":case"octahedron_1":case"octahedron_2":case"octahedron_3":case"octahedron_4":case"dodecahedron_0":case"dodecahedron_1":case"dodecahedron_2":case"dodecahedron_3":case"dodecahedron_4":case"icosahedron_0":case"icosahedron_1":case"icosahedron_2":case"icosahedron_3":case"icosahedron_4":case"cylinder_0":case"torus_0":case"torus knot_0":("cylinder_0"!=eR||"torus_0"!=eR||"cylinder_0"==eR&&16==k&&40==O||"torus_0"==eR&&16==k&&40==O||"torus knot_0"==eR&&16==k&&40==O)&&(ep=!0,ev=`${D=`${moduleBase}/new%20shapes/`}${eR}.json`)}if(ep)await fetch(ev).then(e=>e.json()).then(e=>{ec=e.vertices,el=e.normals,e$=e.normalVecs,ef=e.uvs,ep=!0});else if("custom shape"===v){if((cacheItem=cache.customShapes.filter(e=>e.url==D)).length){var em=cacheItem[0].data;ec=em.vertices,el=em.normals,e$=em.normalVecs,ef=em.uvs,console.log("found custom shape found in cache. using it"),ep=!0}ep||await fetch(ev).then(e=>e.json()).then(e=>{ec=e.vertices,el=e.normals,e$=e.normalVecs,ef=e.uvs,ep=!0,cache.customShapes.push({data:e,url:D})})}if(ep)switch(v){case"tetrahedron":case"octahedron":case"dodecahedron":case"icosahedron":W=!0}else{switch(v){case"tetrahedron":W=!0,(A=await Tetrahedron(z,G,H,K,v)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"octahedron":W=!0,(A=await Octahedron(z,G,H,K,v)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"icosahedron":W=!0,(A=await Icosahedron(z,G,H,K,v)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"torus":(A=await Torus(z,G,H,K,v,k,O)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"torus knot":(A=await TorusKnot(z,G,H,K,v,k,O)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"cylinder":(A=await Cylinder(z,G,H,K,v,k,O)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"cube":(A=await Cube(z,G,H,K,v)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"rectangle":(A=await Rectangle(z,G,H,K,v)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"sprite":J=!0,(A=await Rectangle(z,G,H,K,v)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"point light":ee=!0,(A=eo?await Rectangle(Math.max(z,.5),G-1,H,K,v):{geometry:[]}).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]});break;case"obj":void 0===o&&(o=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===s&&(s=0),void 0===c&&(c=0),ec=(A=await LoadOBJ(D,z,o,t,i,n,s,c,!1)).vertices,el=A.normals,ef=A.uvs;break;case"dodecahedron":W=!0,(A=await Dodecahedron(z,G,H,K,v)).geometry.map(e=>{ec=[...ec,...e.position],el=[...el,...e.normal],ef=[...ef,...e.texCoord]})}for(var ed=0;ed<ec.length;ed+=3)ec[ed+0]*=N,ec[ed+1]*=w,ec[ed+2]*=M;if("obj"!=v&&"customShape"!=v)for(var ed=0;ed<el.length;ed+=6){var eu=el[ed+3]-el[ed+0],eh=el[ed+4]-el[ed+1],e_=el[ed+5]-el[ed+2];el[ed+0]*=N,el[ed+1]*=w,el[ed+2]*=M,el[ed+3]=el[ed+0]+eu,el[ed+4]=el[ed+1]+eh,el[ed+5]=el[ed+2]+e_}}if("custom shape"!=v&&"obj"!=v||H||N||w||M)for(var eg=H,e0=1-H,ed=0;ed<ec.length;ed+=3){var ev,eR,ey,eE,eb,ex=ec[ed+0],e8=ec[ed+1],eA=ec[ed+2];eE=Math.hypot(ex,e8,eA)+1e-4,ex/=eE,e8/=eE,eA/=eE,ex*=eg+eE*e0,e8*=eg+eE*e0,eA*=eg+eE*e0,ec[ed+0]=ex*z*N,ec[ed+1]=e8*z*w,ec[ed+2]=eA*z*M;var eT=el[2*ed+0],eI=el[2*ed+1],eP=el[2*ed+2];el[2*ed+0]+=ec[ed+0]-eT,el[2*ed+1]+=ec[ed+1]-eI,el[2*ed+2]+=ec[ed+2]-eP,el[2*ed+3]+=ec[ed+0]-eT,el[2*ed+4]+=ec[ed+1]-eI,el[2*ed+5]+=ec[ed+2]-eP,el[2*ed+0]*=N,el[2*ed+1]*=w,el[2*ed+2]*=M,el[2*ed+3]*=N,el[2*ed+4]*=w,el[2*ed+5]*=M}if(V&&AverageNormals(ec,el,v),!ep||V||T){e$=[];for(var ed=0;ed<el.length;ed+=6){let eF=el[ed+3]-el[ed+0],e1;e$=[...e$,eF,el[ed+4]-el[ed+1],el[ed+5]-el[ed+2]]}}if(K&&!T){for(var ed=0;ed<el.length;ed+=6)el[ed+3]=el[ed+0]-(el[ed+3]-el[ed+0]),el[ed+4]=el[ed+1]-(el[ed+4]-el[ed+1]),el[ed+5]=el[ed+2]-(el[ed+5]-el[ed+2]);for(var ed=0;ed<e$.length;ed+=3)e$[ed+0]*=-1,e$[ed+1]*=-1,e$[ed+2]*=-1}if(T&&"background"!==g){var eS=document.createElement("div");eS.style.position="fixed",eS.style.zIndex=1e5,eS.style.left="50%",eS.style.top="50%",eS.style.transform="translate(-50%, -50%)",eS.style.background="#0008",eS.style.padding="20px",eS.style.width="600px",eS.style.height="350px",eS.style.border="1px solid #fff4",eS.style.borderRadius="5px",eS.style.fontFamily="monospace",eS.style.fontSize="20px",eS.style.color="#fff";var eC=document.createElement("div");eC.style.fontSize="24px",eC.style.color="#0f8c",eC.innerHTML=`Export Coordinates File -> ${v} `+(a?.name?`(${a.name})`:"")+"<br><br>",eS.appendChild(eC);var eL=document.createElement("div");eL.style.minWidth="100%",eL.style.height="250px",eL.style.background="#333",eL.style.border="1px solid #fff4",eL.style.overflowY="auto",eL.style.wordWrap="break-word",eL.style.color="#888",eL.style.fontSize="10px",eS.appendChild(eL);var eB=document.createElement("button");eB.style.border="none",eB.style.padding="3px",eB.style.cursor="pointer",eB.fontSize="20px",eB.style.borderRadius="10px",eB.style.margin="10px",eB.style.minWidth="100px",eB.innerHTML="\uD83D\uDCCB copy",eB.title="copy shape data to clipboard",eB.onclick=()=>{var e=document.createRange();e.selectNode(eL),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),eB.innerHTML="COPIED!",setTimeout(()=>{eB.innerHTML="\uD83D\uDCCB copy"},1e3)},eS.appendChild(eB);var eU=document.createElement("button");eU.onclick=()=>eS.remove(),eU.style.border="none",eU.style.padding="3px",eU.style.cursor="pointer",eU.fontSize="20px",eU.style.borderRadius="10px",eU.style.margin="10px",eU.style.background="#faa",eU.style.minWidth="100px",eU.innerHTML="close",eS.appendChild(eU);var eN={vertices:[],normals:[],normalVecs:[],uvs:[]};ec.map(e=>eN.vertices.push(Math.round(1e3*e)/1e3));for(var ed=0;ed<el.length;ed+=6){var ew=el[ed+0],eM=el[ed+1],ek=el[ed+2],e3=K?el[ed+0]-(el[ed+3]-el[ed+0]):el[ed+3],eO=K?el[ed+1]-(el[ed+4]-el[ed+1]):el[ed+4],eD=K?el[ed+2]-(el[ed+5]-el[ed+2]):el[ed+5];ew=Math.round(1e3*ew)/1e3,eM=Math.round(1e3*eM)/1e3,ek=Math.round(1e3*ek)/1e3,e3=Math.round(1e3*e3)/1e3,eO=Math.round(1e3*eO)/1e3,eD=Math.round(1e3*eD)/1e3,eN.normals.push(ew,eM,ek,e3,eO,eD)}for(var ed=0;ed<e$.length;ed++)eN.normalVecs.push((K?-1:1)*Math.round(1e3*e$[ed])/1e3);ef.map(e=>eN.uvs.push(Math.round(1e3*e)/1e3)),eL.innerHTML=JSON.stringify(eN),document.body.appendChild(eS)}ec=new Float32Array(ec),el=new Float32Array(el),e$=new Float32Array(e$),ef=new Float32Array(ef),l=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,l),r.bufferData(r.ARRAY_BUFFER,ec,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),y=new Uint32Array(Array(ec.length/3).fill().map((e,a)=>a)),$=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,$),r.bufferData(r.ELEMENT_ARRAY_BUFFER,y,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),d=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,d),r.bufferData(r.ARRAY_BUFFER,e$,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),b=new Uint32Array(Array(e$.length/3).fill().map((e,a)=>a)),u=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,u),r.bufferData(r.ELEMENT_ARRAY_BUFFER,b,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),f=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,f),r.bufferData(r.ARRAY_BUFFER,el,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),E=new Uint32Array(Array(el.length/3).fill().map((e,a)=>a)),p=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,p),r.bufferData(r.ELEMENT_ARRAY_BUFFER,E,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),h=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,h),r.bufferData(r.ARRAY_BUFFER,ef,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),x=new Uint32Array(Array(ef.length/2).fill().map((e,a)=>a)),_=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,_),r.bufferData(r.ELEMENT_ARRAY_BUFFER,x,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);var ez={x:I,y:P,z:F,roll:L,pitch:B,yaw:U,color:Y,colorMix:X,size:z,subs:G,name:g,url:D,averageNormals:V,showNormals:q,shapeType:v,exportShape:T,sphereize:H,equirectangular:W,flipNormals:K,vertices:ec,normals:el,normalVecs:e$,uvs:ef,vertex_buffer:l,Vertex_Index_Buffer:$,normal_buffer:f,Normal_Index_Buffer:p,muted:Z,normalVec_buffer:d,NormalVec_Index_Buffer:u,nVecIndices:b,uv_buffer:h,UV_Index_Buffer:_,vIndices:y,nIndices:E,uvIndices:x,map:j,video:m,textureMode:er,isSprite:J,isLight:ee,playbackSpeed:ea,disableDepthTest:et,lum:ei,alpha:en};Object.keys(ez).forEach((e,a)=>{es[e]=ez[e]}),"point light"==v&&(void 0===a.color&&(es.color=11184810),e.pointLights.push(es));let e2=await BasicShader(e,[{uniform:{type:"phong",value:0}}]);return await e2.ConnectGeometry(es),es},GenericPopup=async(e="",a=!1,r=()=>{},o=400,t=300)=>{var i=document.createElement("div");i.style.position="fixed",i.style.zIndex=1e5,i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%, -50%)",i.style.background="#0008",i.style.padding="20px",i.style.width=`${o}px`,i.style.height=`${t}px`,i.style.border="1px solid #fff4",i.style.borderRadius="5px",i.style.fontFamily="monospace",i.style.fontSize="20px",i.style.color="#fff";var n=document.createElement("div");if(n.style.fontSize="24px",n.style.color="#0f8c",n.innerHTML=e,i.appendChild(n),a){var s=document.createElement("button");s.onclick=()=>{r(),i.remove()},s.style.border="none",s.style.padding="3px",s.style.cursor="pointer",s.fontSize="20px",s.style.borderRadius="10px",s.style.margin="10px",s.style.background="#faa",s.style.minWidth="100px",s.innerHTML="SURE!",i.appendChild(s)}var c=document.createElement("button");c.onclick=()=>i.remove(),c.style.border="none",c.style.padding="3px",c.style.cursor="pointer",c.fontSize="20px",c.style.borderRadius="10px",c.style.margin="10px",c.style.background="#faa",c.style.minWidth="100px",c.innerHTML="close",i.appendChild(c),document.body.appendChild(i)},ImageToPo2=async e=>{let a=e;if(!(IsPowerOf2(e.width)&&IsPowerOf2(e.height))){let r=document.createElement("canvas"),o=r.getContext("2d"),t=8,i=0,n=6e6,s,c,l=Math.hypot(e.width,e.height);for(let $=0;$<16;$++)(s=Math.abs(i-l))<n&&(n=s,i=t*2**$,c=$);i-=t*2**(c-1),r.width=i,r.height=i,o.drawImage(e,0,0,r.width,r.height),(a=new Image).src=r.toDataURL()}return a},VideoToImage=async e=>{if(void 0===e)return scratchCanvas.width=1,scratchCanvas.height=1,scratchCanvas;{let a,r;if(scratchCanvas.width!=e.videoWidth||scratchCanvas.height!=e.videoHeight?(a=e.videoWidth,r=e.videoHeight):(a=scratchCanvas.width,r=scratchCanvas.height),!(IsPowerOf2(a)&&IsPowerOf2(r))){let o=8,t=0,i=6e6,n,s,c=Math.hypot(a,r);for(let l=0;l<12;l++)(n=Math.abs(t-c))<i&&(i=n,t=o*2**l,s=l);t-=o*2**(s-1),a=(t=Math.min(1024,t))/1,r=t/1}return(scratchCanvas.width!=a||scratchCanvas.width!=r)&&(scratchCanvas.width=a,scratchCanvas.height=r),await sctx.drawImage(e,0,0,scratchCanvas.width,scratchCanvas.height),scratchCanvas}},BindImage=async(e,a,r,o="image",t=-1,i="")=>{let n;switch(o){case"video":(cacheItem=cache.texImages.filter(e=>e.url==i&&-1!=t&&e.tVal==t)).length?(console.log("found video texture in cache... using it"),n=cacheItem[0].texImage):(n=await VideoToImage(a),-1==t&&cache.texImages.push({url:i,tval:t,texImage:n}));break;case"image":(cacheItem=cache.texImages.filter(e=>e.url==i)).length?(console.log("found image texture in cache... using it"),n=cacheItem[0].texImage):(n=await ImageToPo2(a),cache.texImages.push({url:i,tval:t,texImage:n}))}e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)},AverageNormals=(e,a,r)=>{a.length=0;for(var o,t,i,n,s,c,l,$,f,p,m,d,u,h,_,g,v,y,E=IsPolyhedron(r),b=0;b<e.length;b+=3)b%9||(o=Normal([[e[b+0],e[b+1],e[b+2]],[e[b+3],e[b+4],e[b+5]],[e[b+6],e[b+7],e[b+8]]],E)),a[2*b+0]=e[b+0],a[2*b+1]=e[b+1],a[2*b+2]=e[b+2],a[2*b+3]=e[b+0]+(o[0]-o[3]),a[2*b+4]=e[b+1]+(o[1]-o[4]),a[2*b+5]=e[b+2]+(o[2]-o[5]);for(var x=[],A=structuredClone(a),b=0;b<a.length;b+=6){l=a[b+0],$=a[b+1],f=a[b+2],p=a[b+3],m=a[b+4],d=a[b+5],n=p,s=m,c=d,i=1;for(var T=0;T<a.length;T+=6)T!=b&&(u=a[T+0],h=a[T+1],_=a[T+2],g=a[T+3],v=a[T+4],y=a[T+5],.01>Math.hypot(l-u,$-h,f-_)&&(n+=g,s+=v,c+=y,i++));A[b+3]=n/=i,A[b+4]=s/=i,A[b+5]=c/=i}A.map((e,r)=>a[r]=e)},BasicShader=async(e,a=[])=>{let r=e.gl;var o,t={iURL:null,locT:null,locUv:null,locFov:null,program:null,optionalUniforms:[],optionalLighting:[]};a.map(a=>{Object.keys(a).forEach((r,o)=>{switch(r.toLowerCase()){case"lighting":if("ambientlight"===a[r].type.toLowerCase()&&(void 0===a[r]?.enabled||a[r].enabled)){var i={name:a[r].type,value:void 0===a[r].value?e.ambientLight:a[r].value};t.optionalLighting.push(i)}break;case"uniform":switch(a[r].type.toLowerCase()){case"reflection":if(void 0===a[r]?.enabled||a[r].enabled){var n={name:a[r].type,muted:void 0===a[r].muted||a[r].muted,map:a[r].map,loc:"locReflection",value:void 0===a[r].value?.5:a[r].value,flatShading:void 0!==a[r].flatShading&&a[r].flatShading,flipReflections:void 0!==a[r].flipReflections&&a[r].flipReflections,flatShadingUniform:"refFlatShading",dataType:"uniform1f",vertDeclaration:`
varying vec3 reflectionPos;
`,vertCode:`
reflectionPos = nVec;
`,fragDeclaration:`
uniform float reflection;
uniform float refFlatShading;
uniform float refOmitEquirectangular;
uniform float refFlipRefs;
uniform sampler2D reflectionMap;
varying vec3 reflectionPos;
`,fragCode:`
light.rgb *= .5;
light.rgb += .05;
float refP1, refP2;
if(refOmitEquirectangular != 1.0){
float px = reflectionPos.x;
float py = reflectionPos.y;
float pz = reflectionPos.z;
refP1 = -atan(px, pz)/ M_PI / 2.0 + camOri.z / M_PI / 2.0;
refP2 = acos( py / sqrt(px * px + py * py + pz * pz)) / M_PI;
if(refFlipRefs != 0.0) refP2 = 1.0 - refP2;
} else {
refP1 = vUv.x;
refP2 = vUv.y;
}

vec2 refCoords = vec2(1.0 - refP1, refP2);
vec4 refCol = vec4(texture2D(reflectionMap, vec2(refCoords.x, refCoords.y)).rgb * 1.25, reflection / 2.0);
mixColor = merge(mixColor, refCol);
baseColorIp = 1.0 - reflection;
//light += reflection / 4.0;
`};t.optionalUniforms.push(n)}break;case"phong":if(void 0===a[r]?.enabled||a[r].enabled){var n={name:a[r].type,loc:"locPhong",value:void 0===a[r].value?.3:a[r].value,flatShading:void 0!==a[r].flatShading&&a[r].flatShading,flatShadingUniform:"phongFlatShading",theta:void 0===a[r].theta?.6+Math.PI:a[r].theta,dataType:"uniform1f",vertDeclaration:`
varying vec3 phongPos;
`,vertCode:`
phongPos = nVec;//R(nVeci, geoOri);
hasPhong = 1.0;
`,fragDeclaration:`
uniform float phong;
uniform float phongTheta;
uniform float phongFlatShading;
varying vec3 phongPos;
`,fragCode:`
if(isLight == 0.0 && isSprite == 0.0){
//light.rgb *= .5;
float phongP1, phongP2;
float px, py, pz;
if(flatShading != 0.0){
px = nVec.x;
py = nVec.y;
pz = nVec.z;
}else{
px = phongPos.x;
py = phongPos.y;
pz = phongPos.z;
}
phongP1 = (atan(px, pz) - camOri.z) + phongTheta;
phongP2 = -acos( py / (.001 + sqrt(px * px + py * py + pz * pz)));

float fact = pow(pow((1.0+cos(phongP1)) * (1.0+cos(phongP2+M_PI/2.0+.2)), 2.0), 2.0) / 400.0 * phong ;
light = vec4(light.rgb + fact, 1.0) * 15.0;
}
`};t.optionalUniforms.push(n)}}}})});let i={ConnectGeometry:null,datasets:[]};r.enable(r.DEPTH_TEST),r.cullFace(r.BACK),e.alpha&&(r.blendFunc(r.SRC_ALPHA,r.ONE),r.enable(r.BLEND),r.disable(r.DEPTH_TEST));let n="";t.optionalUniforms.map(e=>{n+="\n"+e.vertDeclaration+"\n"});let s="";t.optionalUniforms.map(e=>{s+="\n"+e.vertCode+"\n"});let c="";t.optionalUniforms.map(e=>{c+="\n"+e.fragDeclaration+"\n"});let l="";t.optionalUniforms.map(e=>{l+="\n"+e.fragCode+"\n"}),i.vert=`
precision highp float;
#define M_PI 3.14159265358979323
attribute vec2 uv;
${n}

uniform float t;
uniform vec3 color;
uniform float ambientLight;
uniform vec3 camPos;
uniform vec3 camOri;
uniform vec3 geoPos;
uniform vec3 geoOri;
uniform float isSprite;
uniform float isLight;
//uniform vec4 pointLightPos[16];
uniform float fov;
uniform float equirectangular;
uniform float renderNormals;
uniform vec2 resolution;
attribute vec3 position;
attribute vec3 normal;
attribute vec3 normalVec;
varying vec2 vUv;
varying vec2 uvi;
varying vec3 nVec;
varying vec3 nVeci;
varying vec3 fPos;
varying vec3 fPosi;
varying vec3 vnorm;
varying float skip;
varying float hasPhong;


vec3 R(vec3 pos, vec3 rot){
float p, d;
pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));
pos.z = cos(p)*d;
pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));
pos.z = cos(p)*d;
pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));
pos.y = cos(p)*d;
return pos;
}

void main(){
hasPhong = 0.0;

float cx, cy, cz;
if(renderNormals == 1.0){
cx = normal.x;
cy = normal.y;
cz = normal.z;
}else{
cx = position.x;
cy = position.y;
cz = position.z;
}


uvi = uv / 2.0;
uvi = vec2(uvi.x, .5 - uvi.y);

nVeci = normalVec;

fPosi = position;
vnorm = normal;


// camera rotation

vec3 geo, pos;

if(isSprite != 0.0 || isLight != 0.0){

geo = R(geoPos, camOri);
pos = R(vec3(cx, cy, cz),
vec3(0.0, -camOri.y + M_PI, 0.0));
pos = R(vec3(pos.x, pos.y, pos.z),
vec3(-camOri.x, 0.0, -camOri.z ));
pos = R(vec3(pos.x, pos.y, pos.z), camOri);
nVec = vec3(normalVec.x, normalVec.y, normalVec.z);
nVec = R(nVec, geoOri);
nVec = R(nVec, vec3(0.0, camOri.y, camOri.z));

}else{
geo = R(geoPos, camOri);
pos = R(vec3(cx, cy, cz), geoOri);
pos = R(vec3(pos.x, pos.y, pos.z), camOri);
nVec = vec3(normalVec.x, normalVec.y, normalVec.z);
nVec = R(nVec, geoOri);
nVec = R(nVec, vec3(0.0, camOri.y, camOri.z));
}
fPos = vec3(pos.x, pos.y, pos.z);

${s}

float camz = camPos.z / 1e3 * pow(5.0, (log(fov) / 1.609438));

float Z = pos.z + camz + geo.z;
if(Z > 0.0) {
float X = ((pos.x + camPos.x + geo.x) / Z * fov / resolution.x);
float Y = ((pos.y + camPos.y + geo.y) / Z * fov / resolution.y);
//gl_PointSize = 100.0 / Z;
gl_Position = vec4(X, Y, Z/100000.0, 1.0);
skip = 0.0;
vUv = uv;
}else{
skip = 1.0;
}
}
`,i.frag=`
precision highp float;
#define M_PI 3.14159265358979323
${c}
uniform float t;
uniform vec2 resolution;
uniform float flatShading;
uniform float isSprite;
uniform float isLight;
uniform vec4 pointLightPos[128];
uniform vec4 pointLightCol[128];
uniform int pointLightCount;
uniform float ambientLight;
uniform float renderNormals;
uniform float equirectangular;
uniform float colorMix;
uniform vec3 color;
uniform sampler2D baseTexture;
uniform float alpha;
uniform vec3 camPos;
uniform vec3 camOri;
uniform vec3 geoPos;
uniform vec3 geoOri;
varying vec2 vUv;
varying vec2 uvi;
varying vec3 vnorm;
varying vec3 nVec;
varying vec3 nVeci;
varying vec3 fPos;
varying vec3 fPosi;
varying float skip;
varying float hasPhong;

vec4 merge (vec4 col1, vec4 col2){
return vec4((col1.rgb * col1.a) + (col2.rgb * col2.a), 1.0);
}

vec2 Coords(float flatShading) {
if(equirectangular == 1.0){
float p;
float p2;
p = flatShading == 1.0 ? atan(nVeci.x, nVeci.z): atan(fPosi.x, fPosi.z);
float p1;
p1 = p / M_PI / 2.0;
p2 = flatShading == 1.0 ?
acos(nVec.y / (sqrt(nVeci.x*nVec.x + nVec.y*nVec.y + nVec.z*nVec.z)+.00001)) / M_PI   :
p2 = acos(fPosi.y / (sqrt(fPosi.x*fPosi.x + fPosi.y*fPosi.y + fPosi.z*fPosi.z)+.00001)) / M_PI;
return vec2(p1, p2);
}else{
return vUv;
}
}

vec3 R(vec3 pos, vec3 rot){
float p, d;
pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));
pos.z = cos(p)*d;
pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));
pos.z = cos(p)*d;
pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));
pos.y = cos(p)*d;
return pos;
}

vec4 GetPointLight(){

float ret = 0.0;
vec4 rgba = vec4(0.0, 0.0, 0.0, 1.0);
for(int i=0; i < 16; i++){
if(i >= pointLightCount) break;
vec3 lpos = pointLightPos[i].xyz;
lpos.x -= geoPos.x;
lpos.y -= geoPos.y;
lpos.z -= geoPos.z;
lpos = R(lpos, vec3(camOri.x, 0.0, camOri.z ));
lpos = R(lpos, vec3(0.0, camOri.y, 0.0));

float mag = pointLightPos[i].w;
ret = mag / (1.0 + pow(1.0 + sqrt((lpos.x-fPos.x) * (lpos.x-fPos.x) +
(lpos.y-fPos.y) * (lpos.y-fPos.y) +
(lpos.z-fPos.z) * (lpos.z-fPos.z)), 2.0) / 3.0) * 40.0;

rgba.r += ret * pointLightCol[i].r;
rgba.g += ret * pointLightCol[i].g;
rgba.b += ret * pointLightCol[i].b;
}

return pointLightCount > 0 ? vec4(rgba.rgb + ambientLight, 1.0) : vec4(ambientLight, ambientLight, ambientLight, 1.0);
}

void main() {
float mixColorIp = colorMix;
float baseColorIp = 1.0 - mixColorIp;
vec4 mixColor = vec4(color.rgb, mixColorIp);
vec4 light = hasPhong == 1.0 ? GetPointLight() :
vec4(ambientLight, ambientLight, ambientLight, 1.0);
float colorMag = 1.0;
if(skip != 1.0){
if(renderNormals == 1.0){
gl_FragColor = vec4(1.0, 0.0, 0.0, 0.5);
}else{
${l}
vec4 texel = texture2D( baseTexture, Coords(0.0));
if(isSprite != 0.0 || isLight != 0.0){
gl_FragColor = vec4(texel.rgb * 2.0, texel.a * alpha);
}else{
texel.a = baseColorIp;
vec4 col = merge(mixColor, texel);
col.rgb *= light.rgb;
gl_FragColor = vec4(col.rgb * colorMag, 1.0);
}
}
}
}
`;let $=r.createShader(r.VERTEX_SHADER);r.shaderSource($,i.vert),r.compileShader($);let f=r.createShader(r.FRAGMENT_SHADER);return r.shaderSource(f,i.frag),r.compileShader(f),i.ConnectGeometry=async a=>{var o=structuredClone(t);i.datasets=[...i.datasets,o],o.program=r.createProgram(),r.attachShader(o.program,$),r.attachShader(o.program,f),r.linkProgram(o.program),a.shader=i;var n=a.map;if(a.datasetIdx=i.datasets.length-1,r.getProgramParameter(o.program,r.LINK_STATUS)){r.useProgram(o.program),r.bindBuffer(r.ARRAY_BUFFER,a.vertex_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.Vertex_Index_Buffer),o.locPosition=r.getAttribLocation(o.program,"position"),r.vertexAttribPointer(o.locPosition,3,r.FLOAT,!1,0,0),r.enableVertexAttribArray(o.locPosition),r.bindBuffer(r.ARRAY_BUFFER,a.uv_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.UV_Index_Buffer),o.locUv=r.getAttribLocation(o.program,"uv"),r.vertexAttribPointer(o.locUv,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(o.locUv),r.bindBuffer(r.ARRAY_BUFFER,a.normal_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.Normal_Index_Buffer),o.locNormal=r.getAttribLocation(o.program,"normal"),r.vertexAttribPointer(o.locNormal,3,r.FLOAT,!0,0,0),r.enableVertexAttribArray(o.locNormal),r.bindBuffer(r.ARRAY_BUFFER,a.normalVec_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.NormalVec_Index_Buffer),o.locNormalVec=r.getAttribLocation(o.program,"normalVec"),r.vertexAttribPointer(o.locNormalVec,3,r.FLOAT,!0,0,0),r.enableVertexAttribArray(o.locNormalVec),a.isLight||o.optionalUniforms.map(async e=>{let t;switch(e.name){case"reflection":var n=e.map;if(n){let s,c=(s=n.split("."))[s.length-1].toLowerCase();switch(e.refTexture=r.createTexture(),c){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",(cacheItem=cache.textures.filter(e=>e.url==n)).length?(console.log("found video in cache... using it"),e.video=cacheItem[0].resource,i.datasets=[...i.datasets,{texture:cacheItem[0].texture,iURL:n}],BindImage(r,e.video,e.refTexture,e.textureMode,-1,n)):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=a.playbackSpeed,e.video.defaultPlaybackRate=a.playbackSpeed,i.datasets=[...i.datasets,{texture:e.refTexture,iURL:n}],e.video.loop=!0,e.muted||GenericPopup("play audio OK?",!0,()=>{cache.textures.filter(e=>e.url==n)[0].resource.muted=!1,cache.textures.filter(e=>e.url==n)[0].resource.currentTime=0,cache.textures.filter(e=>e.url==n)[0].resource.play()}),e.video.oncanplay=async()=>{e.video.play(),BindImage(r,e.video,e.refTexture,e.textureMode,-1,n)},await fetch(n).then(e=>e.blob()).then(a=>{e.video.src=URL.createObjectURL(a)}),cache.textures.push({url:n,resource:e.video,texture:e.refTexture}));break;default:e.textureMode="image",(cacheItem=cache.textures.filter(e=>e.url==n)).length?(console.log("found image in cache... using it"),t=cacheItem[0].resource,i.datasets=[...i.datasets,{texture:cacheItem[0].texture,iURL:n}],BindImage(r,t,e.refTexture,e.textureMode,-1,n)):(t=new Image,i.datasets=[...i.datasets,{texture:e.refTexture,iURL:n}],r.bindTexture(r.TEXTURE_2D,e.refTexture),await fetch(n).then(e=>e.blob()).then(a=>{t.onload=async()=>BindImage(r,t,e.refTexture,e.textureMode,-1,n),t.src=URL.createObjectURL(a)}),cache.textures.push({url:n,resource:t,texture:e.refTexture}))}}r.useProgram(o.program),e.locRefOmitEquirectangular=r.getUniformLocation(o.program,"refOmitEquirectangular"),r.uniform1f(e.locRefOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType?1:0),e.locRefFlipRefs=r.getUniformLocation(o.program,"refFlipRefs"),r.uniform1f(e.locRefFlipRefs,e.flipReflections),e.locRefTexture=r.getUniformLocation(o.program,"reflectionMap"),r.bindTexture(r.TEXTURE_2D,e.refTexture),r.uniform1i(e.locRefTexture,1),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,e.refTexture);break;case"phong":e.locPhongTheta=r.getUniformLocation(o.program,e.theta),r.uniform1f(e.locPhongTheta,e.theta)}e.locFlatShading=r.getUniformLocation(o.program,e.flatShadingUniform),r.uniform1f(e.locFlatShading,e.flatShading?1:0),e.loc=r.getUniformLocation(o.program,e.name),r[e.dataType](e.loc,e.value)}),o.locColor=r.getUniformLocation(o.program,"color"),r.uniform3f(o.locColor,...HexToRGB(a.color)),o.locColorMix=r.getUniformLocation(o.program,"colorMix"),r.uniform1f(o.locColorMix,a.colorMix),o.locIsSprite=r.getUniformLocation(o.program,"isSprite"),r.uniform1f(o.locIsSprite,a.isSprite),o.locIsLight=r.getUniformLocation(o.program,"isLight"),r.uniform1f(o.locIsLight,a.isLight),o.locAlpha=r.getUniformLocation(o.program,"alpha"),r.uniform1f(o.locAlpha,a.alpha),o.locPointLights=r.getUniformLocation(o.program,"pointLightPos[0]"),o.locPointLightCols=r.getUniformLocation(o.program,"pointLightCol[0]"),o.locPointLightCount=r.getUniformLocation(o.program,"pointLightCount"),r.uniform1i(o.locPointLightCount,0),o.locResolution=r.getUniformLocation(o.program,"resolution"),r.uniform2f(o.locResolution,e.width,e.height),o.locEquirectangular=r.getUniformLocation(o.program,"equirectangular"),r.uniform1f(o.locEquirectangular,a.equirectangular?1:0),o.locT=r.getUniformLocation(o.program,"t"),r.uniform1f(o.locT,0),o.locAmbientLight=r.getUniformLocation(o.program,"ambientLight"),r.uniform1f(o.locAmbientLight,e.ambientLight),o.texture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,o.texture),o.locTexture=r.getUniformLocation(o.program,"baseTexture");let s;if(o.iURL=n,n){let c,l=(c=n.split("."))[c.length-1].toLowerCase();switch(l){case"mp4":case"webm":case"avi":case"mkv":case"ogv":o.video=document.createElement("video"),o.video.muted=!0,o.video.playbackRate=a.playbackSpeed,o.video.defaultPlaybackRate=a.playbackSpeed,a.textureMode="video",(cacheItem=cache.textures.filter(e=>e.url==o.iURL)).length?(console.log("found video in cache... using it"),o.video=cacheItem[0].resource,o.texture=cacheItem[0].texture,BindImage(r,o.video,o.texture,a.textureMode,-1,o.iURL)):(o.video.loop=!0,a.muted||GenericPopup("play audio OK?",!0,()=>{o.video.muted=!1,o.video.currentTime=0,o.video.play()}),o.video.oncanplay=async()=>{o.video.play(),BindImage(r,o.video,o.texture,a.textureMode,-1,o.iURL)},await fetch(o.iURL).then(e=>e.blob()).then(e=>{o.video.src=URL.createObjectURL(e)}),cache.textures.push({url:o.iURL,resource:o.video,texture:o.texture}));break;default:a.textureMode="image",(cacheItem=cache.textures.filter(e=>e.url==o.iURL)).length?(o.texture=cacheItem[0].texture,BindImage(r,s=cacheItem[0].resource,o.texture,a.textureMode,-1,o.iURL)):(s=new Image,await fetch(o.iURL).then(e=>e.blob()).then(e=>{s.src=URL.createObjectURL(e)}),s.onload=async()=>{BindImage(r,s,o.texture,a.textureMode,-1,o.iURL),cache.textures.push({url:o.iURL,resource:s,texture:o.texture})})}}r.useProgram(o.program),r.uniform1i(o.locTexture,0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,o.texture),o.locCamPos=r.getUniformLocation(o.program,"camPos"),o.locCamOri=r.getUniformLocation(o.program,"camOri"),o.locGeoPos=r.getUniformLocation(o.program,"geoPos"),o.locGeoOri=r.getUniformLocation(o.program,"geoOri"),o.locFov=r.getUniformLocation(o.program,"fov"),o.locRenderNormals=r.getUniformLocation(o.program,"renderNormals"),r.uniform3f(o.locCamPos,e.x,e.y,e.z),r.uniform3f(o.locCamOri,e.roll,e.pitch,e.yaw),r.uniform3f(o.locGeoPos,e.x,e.y,e.z),r.uniform3f(o.locGeoOri,a.roll,a.pitch,a.yaw),r.uniform1f(o.locFov,e.fov),r.uniform1f(o.locRenderNormals,0)}else{var p=r.getProgramInfoLog(o.program),m=r.getShaderInfoLog($),d=r.getShaderInfoLog(f);console.error(`bad shader :( ${p}`),console.error(`vShader info : ${m}`),console.error(`fShader info : ${d}`)}},i},IsPolyhedron=e=>{var a;switch(e){case"tetrahedron":case"cube":case"octahedron":case"dodecahedron":case"icosahedron":case"tetrahedron":a=!0;break;default:a=!1}return a},GeometryFromRaw=async(e,a,r,o,t,i,n=!1,s="")=>{var c,l,$,f,p,m,d,u,h,_=[],g=[],v=e,y=[],E=`${s}_${o}`,b=IsPolyhedron(s);for(u="obj"===s?await subbed(0,1,t,v,a,E):await subbed(o+(b?1:0),1,t,v,a,E),u.map(e=>{e.verts.map(e=>{$=e[0]*=r,f=e[1]*=r,p=e[2]*=r}),n?(_=[..._,e.verts[0],e.verts[1],e.verts[2],e.verts[2],e.verts[3],e.verts[0]],g=[...g,e.uvs[0],e.uvs[1],e.uvs[2],e.uvs[2],e.uvs[3],e.uvs[0]]):(_=[..._,...e.verts],g=[...g,...e.uvs])}),l=0;l<_.length;l++)m=[_[3*(c=l/3|0)+0],_[3*c+1],_[3*c+2]],l%3||(h=Normal(m,b),i||(h[3]=h[0]+(h[0]-h[3]),h[4]=h[1]+(h[1]-h[4]),h[5]=h[2]+(h[2]-h[5]))),y=[...y,{position:_[d=i?_.length-l-1:l],normal:[..._[d],_[d][0]+(h[3]-h[0]),_[d][1]+(h[4]-h[1]),_[d][2]+(h[5]-h[2])],texCoord:g[d]}];return{geometry:y}},subbed=async(e,a,r,o,t,i="")=>{for(var n,s,c,l,$,f,p,m,d,u,h,_,g,v,y,E,b,x,A,T,I,P,F,L,B,U,N,w,M,k,O,D,z,V,G,H,Y,X,W,K,q,j,Z,J,ee,ea,er,eo,et,ei,en,es,ec,el,e$,ef,ep,em,ed,eu,eh,e_,eg,e0,ev,eR,ey,eE,eb,ex,e8,eA,eT,eI=e;eI--;)l=o,$=t,o=[],t=[],l.map((e,a)=>{switch(f=0,eb=$[a],u=e[f][0],h=e[f][1],_=e[f][2],B=eb[f][0],U=eb[f][1],g=e[f=1][0],v=e[f][1],y=e[f][2],N=eb[f][0],w=eb[f][1],E=e[f=2][0],b=e[f][1],x=e[f][2],M=eb[f][0],k=eb[f][1],e.length>3&&(A=e[f=3][0],T=e[f][1],I=e[f][2],O=eb[f][0],D=eb[f][1],e.length>4&&(P=e[f=4][0],F=e[f][1],L=e[f][2],z=eb[f][0],V=eb[f][1])),G=(u+g)/2,H=(h+v)/2,Y=(_+y)/2,X=(g+E)/2,W=(v+b)/2,K=(y+x)/2,ei=(B+N)/2,en=(U+w)/2,es=(N+M)/2,ec=(w+k)/2,ev=[],eR=[],e.length){case 3:q=(E+u)/2,j=(b+h)/2,Z=(x+_)/2,el=(M+B)/2,e$=(k+U)/2,p=u,ev=[...ev,[p,m=h,d=_]],p=G,ev=[...ev,[p,m=H,d=Y]],p=q,o=[...o,ev=[...ev,[p,m=j,d=Z]]],ev=[],eR=[...eR,[p=B,m=U]],eR=[...eR,[p=ei,m=en]],t=[...t,eR=[...eR,[p=el,m=e$]]],eR=[],p=G,ev=[...ev,[p,m=H,d=Y]],p=g,ev=[...ev,[p,m=v,d=y]],p=X,o=[...o,ev=[...ev,[p,m=W,d=K]]],ev=[],eR=[...eR,[p=ei,m=en]],eR=[...eR,[p=N,m=w]],t=[...t,eR=[...eR,[p=es,m=ec]]],eR=[],p=q,ev=[...ev,[p,m=j,d=Z]],p=X,ev=[...ev,[p,m=W,d=K]],p=E,o=[...o,ev=[...ev,[p,m=b,d=x]]],ev=[],eR=[...eR,[p=el,m=e$]],eR=[...eR,[p=es,m=ec]],t=[...t,eR=[...eR,[p=M,m=k]]],eR=[],p=G,ev=[...ev,[p,m=H,d=Y]],p=X,ev=[...ev,[p,m=W,d=K]],p=q,o=[...o,ev=[...ev,[p,m=j,d=Z]]],eR=[...eR,[p=ei,m=en]],eR=[...eR,[p=es,m=ec]],t=[...t,eR=[...eR,[p=el,m=e$]]];break;case 4:q=(E+A)/2,j=(b+T)/2,Z=(x+I)/2,J=(A+u)/2,ee=(T+h)/2,ea=(I+_)/2,el=(M+O)/2,e$=(k+D)/2,ef=(O+B)/2,ep=(D+U)/2,eu=(u+g+E+A)/4,eh=(h+v+b+T)/4,e_=(_+y+x+I)/4,ey=(B+N+M+O)/4,eE=(U+w+k+D)/4,p=u,ev=[...ev,[p,m=h,d=_]],p=G,ev=[...ev,[p,m=H,d=Y]],p=eu,ev=[...ev,[p,m=eh,d=e_]],p=J,o=[...o,ev=[...ev,[p,m=ee,d=ea]]],ev=[],eR=[...eR,[p=B,m=U]],eR=[...eR,[p=ei,m=en]],eR=[...eR,[p=ey,m=eE]],t=[...t,eR=[...eR,[p=ef,m=ep]]],eR=[],p=G,ev=[...ev,[p,m=H,d=Y]],p=g,ev=[...ev,[p,m=v,d=y]],p=X,ev=[...ev,[p,m=W,d=K]],p=eu,o=[...o,ev=[...ev,[p,m=eh,d=e_]]],ev=[],eR=[...eR,[p=ei,m=en]],eR=[...eR,[p=N,m=w]],eR=[...eR,[p=es,m=ec]],t=[...t,eR=[...eR,[p=ey,m=eE]]],eR=[],p=eu,ev=[...ev,[p,m=eh,d=e_]],p=X,ev=[...ev,[p,m=W,d=K]],p=E,ev=[...ev,[p,m=b,d=x]],p=q,o=[...o,ev=[...ev,[p,m=j,d=Z]]],ev=[],eR=[...eR,[p=ey,m=eE]],eR=[...eR,[p=es,m=ec]],eR=[...eR,[p=M,m=k]],t=[...t,eR=[...eR,[p=el,m=e$]]],eR=[],p=J,ev=[...ev,[p,m=ee,d=ea]],p=eu,ev=[...ev,[p,m=eh,d=e_]],p=q,ev=[...ev,[p,m=j,d=Z]],p=A,o=[...o,ev=[...ev,[p,m=T,d=I]]],eR=[...eR,[p=ef,m=ep]],eR=[...eR,[p=ey,m=eE]],eR=[...eR,[p=el,m=e$]],t=[...t,eR=[...eR,[p=O,m=D]]];break;case 5:eu=(u+g+E+A+P)/5,eh=(h+v+b+T+F)/5,e_=(_+y+x+I+L)/5,ey=(B+N+M+O+z)/5,eE=(U+w+k+D+V)/5,q=(E+A)/2,j=(b+T)/2,Z=(x+I)/2,J=(A+P)/2,ee=(T+F)/2,ea=(I+L)/2,er=(P+u)/2,eo=(F+h)/2,et=(L+_)/2,el=(M+O)/2,e$=(k+D)/2,ef=(O+z)/2,ep=(D+V)/2,em=(z+B)/2,ed=(V+U)/2,p=u,ev=[...ev,[p,m=h,d=_]],p=g,ev=[...ev,[p,m=v,d=y]],p=eu,o=[...o,ev=[...ev,[p,m=eh,d=e_]]],ev=[],eR=[...eR,[p=B,m=U]],eR=[...eR,[p=N,m=w]],t=[...t,eR=[...eR,[p=ey,m=eE]]],eR=[],p=g,ev=[...ev,[p,m=v,d=y]],p=E,ev=[...ev,[p,m=b,d=x]],p=eu,o=[...o,ev=[...ev,[p,m=eh,d=e_]]],ev=[],eR=[...eR,[p=N,m=w]],eR=[...eR,[p=M,m=k]],t=[...t,eR=[...eR,[p=ey,m=eE]]],eR=[],p=E,ev=[...ev,[p,m=b,d=x]],p=A,ev=[...ev,[p,m=T,d=I]],p=eu,o=[...o,ev=[...ev,[p,m=eh,d=e_]]],ev=[],eR=[...eR,[p=M,m=k]],eR=[...eR,[p=O,m=D]],t=[...t,eR=[...eR,[p=ey,m=eE]]],eR=[],p=A,ev=[...ev,[p,m=T,d=I]],p=P,ev=[...ev,[p,m=F,d=L]],p=eu,o=[...o,ev=[...ev,[p,m=eh,d=e_]]],ev=[],eR=[...eR,[p=O,m=D]],eR=[...eR,[p=z,m=V]],t=[...t,eR=[...eR,[p=ey,m=eE]]],eR=[],p=P,ev=[...ev,[p,m=F,d=L]],p=u,ev=[...ev,[p,m=h,d=_]],p=eu,o=[...o,ev=[...ev,[p,m=eh,d=e_]]],ev=[],eR=[...eR,[p=z,m=V]],eR=[...eR,[p=B,m=U]],t=[...t,eR=[...eR,[p=ey,m=eE]]],eR=[]}});if(r){eg=r,e0=1-r;for(var eI=2;eI--;)(eI?o:t).map(e=>{e.map(e=>{p=e[0],e8=Math.hypot(p,m=e[1],d=eI?e[2]:0),p/=e8,m/=e8,d/=e8,e[0]=p*=eg+e8*e0,e[1]=m*=eg+e8*e0,eI&&(e[2]=d*=eg+e8*e0)})})}return o.map((e,a)=>({verts:e,uvs:t[a]}))},Camera=(e=0,a=0,r=0,o=0,t=0,i=0)=>({x:e,y:a,z:r,roll:o,pitch:t,yaw:i}),GeoSphere=(e,a,r,o,t)=>{let i,n,s,c,l,$,f,p,m,d=0,u,h,_,g,v,y=Array(o).fill().map(e=>(i=Rn()-.5,n=Rn()-.5,s=Rn()-.5,[i,n,s]));for(let E=99;E--;)y.map((e,a)=>{i=e[0],n=e[1],s=e[2],y.map((e,r)=>{r!=a&&(f=e[0],h=1+(Math.hypot(i-f,n-(p=e[1]),s-(m=e[2]))*(3+o/70)*3)**3,i+=(i-f)*9/h,n+=(n-p)*9/h,s+=(s-m)*9/h)}),h=Math.hypot(i,n,s),e[0]=i/h,e[1]=n/h,e[2]=s/h,d&&(h=25+Math.hypot(i,n,s),e[0]=(i-i/h)/1.1,e[1]=(n-n/h)/1.1,e[2]=(s-s/h)/1.1)});return u=6e6,y.map((e,a)=>{c=e[0],l=e[1],$=e[2],y.map((e,r)=>{f=e[0],p=e[1],m=e[2],a!=r&&(h=Math.hypot(_=c-f,g=l-p,v=$-m))<u&&(u=h)})}),_=[],y.map((e,a)=>{c=e[0],l=e[1],$=e[2],y.map((e,r)=>{f=e[0],p=e[1],m=e[2],a!=r&&(h=Math.hypot(c-f,l-p,$-m))<2*u&&!_.filter(e=>e[0]==f&&e[1]==p&&e[2]==m&&e[3]==c&&e[4]==l&&e[5]==$).length&&(_=[..._,[c*t,l*t,$*t,f*t,p*t,m*t]])})}),y.map(o=>{o[0]*=t/1.3333,o[1]*=t/1.3333,o[2]*=t/1.3333,o[0]+=e,o[1]+=a,o[2]+=r}),[e,a,r,t,y,_]},Cylinder=async(e=1,a=0,r=0,o=!1,t,i,n)=>{for(var s,c,l,$,f,p,m,d,u,h,_,g,v,y,E,b,x,A,T,I,P,F=[],L=[],B=0;B<i;B++)for(var U=B-.5,N=0;N<n;N++){s=S(P=2*Math.PI/n*N),c=-.5+1/i*U,l=C(P=2*Math.PI/n*N),$=S(P=2*Math.PI/n*(N+1)),f=-.5+1/i*U,p=C(P=2*Math.PI/n*(N+1)),m=S(P=2*Math.PI/n*(N+1)),d=-.5+1/i*(U+1),u=C(P=2*Math.PI/n*(N+1)),h=S(P=2*Math.PI/n*N),_=-.5+1/i*(U+1),g=C(P=2*Math.PI/n*N);var w=Math.atan2(s,l),M=Math.atan2($,p),k=Math.atan2(m,u),O=Math.atan2(h,g);Math.abs(w-M)>Math.PI&&(w-=2*Math.PI,O-=2*Math.PI),v=(w+Math.PI)/Math.PI/2,y=c+.5,E=(M+Math.PI)/Math.PI/2,b=f+.5,x=(k+Math.PI)/Math.PI/2,A=d+.5,T=(O+Math.PI)/Math.PI/2,I=_+.5,F=[...F,[[s,c,l],[$,f,p],[m,d,u],[h,_,g]]],L=[...L,[[v,y],[E,b],[x,A],[T,I]]]}return await GeometryFromRaw(F,L,e/1.2,a,r,o,!0,t)},Torus=async(e=1,a=0,r=0,o=!1,t,i,n)=>{for(var s,c,l,$,f,p,m,d,u,h,_,g,v,y,E,b,x,A,T,I,P,F,L,B,U,N=[],w=[],M=4*i,k=.5,O=1.25,D=0;D<M;D++)for(var z=D+.5,V=0;V<n;V++){s=S(B=2*Math.PI/n*V)*k+O,c=C(B)*k,B=Math.atan2(s,l=0)+2*Math.PI/M*z+Math.PI/2,U=Math.hypot(s,l),$=S(B)*U,f=c,p=C(B)*U,s=S(B=2*Math.PI/n*(V+1))*k+O,c=C(B)*k,B=Math.atan2(s,l)+2*Math.PI/M*z+Math.PI/2,U=Math.hypot(s,l),m=S(B)*U,d=c,u=C(B)*U,s=S(B=2*Math.PI/n*(V+1))*k+O,c=C(B)*k,B=Math.atan2(s,l)+2*Math.PI/M*(z+1)+Math.PI/2,U=Math.hypot(s,l),h=S(B)*U,_=c,g=C(B)*U,s=S(B=2*Math.PI/n*V)*k+O,c=C(B)*k,B=Math.atan2(s,l)+2*Math.PI/M*(z+1)+Math.PI/2,U=Math.hypot(s,l),v=S(B)*U,y=c,E=C(B)*U;var G=Math.atan2($,p),H=Math.atan2(m,u),Y=Math.atan2(h,g),X=Math.atan2(v,E);Math.abs(G-Y)>Math.PI&&(Y+=2*Math.PI,X+=2*Math.PI),b=(G+Math.PI)/Math.PI/2,x=f+.5,A=(H+Math.PI)/Math.PI/2,T=d+.5,I=(Y+Math.PI)/Math.PI/2,P=_+.5,F=(X+Math.PI)/Math.PI/2,L=y+.5,N=[...N,[[$,f,p],[m,d,u],[h,_,g],[v,y,E]]],w=[...w,[[b,x],[A,T],[I,P],[F,L]]]}return await GeometryFromRaw(N,w,e/1.2,a,r,o,!0,t)},TorusKnot=async(e=1,a=0,r=0,o=!1,t,i,n)=>{var s,c,l,$=[],f=[],p=8*i;n/=1;for(var m,d,u,h,_,g,v,y,E,b,x,A,T,I,P,F,L,B,U,N,w,M,k,O,D,z,V,G,H,Y,X,W,K=.75,q=3,j=1,Z=0;Z<2*p;Z++)for(var J=0;J<n;J++){var ee=Z+.5,ea=Z+1.5,er=Z+2.5;h=q+S(G=3*Math.PI*j/p*ee)/1,_=s=2*C(G),v=q+S(H=3*Math.PI*j/p*ea)/1,y=c=2*C(H),b=q+S(Y=3*Math.PI*j/p*er)/1,x=l=2*C(Y),X=(Math.acos((y-_)/(Math.hypot(v-h,y-_)+1e-4))-Math.PI/2)/2,W=(Math.acos((x-y)/(Math.hypot(b-v,x-y)+1e-4))-Math.PI/2)/2;var eo=q+S(G)/1;m=S(O=2*Math.PI/n*J)*K+eo,O=Math.atan2(d=C(O)*K+s,u=0)+X,D=Math.hypot(d,u),d=S(O)*D,u=C(O)*D,O=Math.atan2(m,u)+2*Math.PI/p*ee+Math.PI/2,D=Math.hypot(m,u),h=S(O)*D,_=d,g=C(O)*D,m=S(O=2*Math.PI/n*(J+1))*K+eo,O=Math.atan2(d=C(O)*K+s,u=0)+X,D=Math.hypot(d,u),d=S(O)*D,u=C(O)*D,O=Math.atan2(m,u)+2*Math.PI/p*ee+Math.PI/2,D=Math.hypot(m,u),v=S(O)*D,y=d,E=C(O)*D,eo=q+S(H)/1,m=S(O=2*Math.PI/n*(J+1))*K+eo,O=Math.atan2(d=C(O)*K+c,u=0)+W,D=Math.hypot(d,u),d=S(O)*D,u=C(O)*D,O=Math.atan2(m,u)+2*Math.PI/p*ea+Math.PI/2,D=Math.hypot(m,u),b=S(O)*D,x=d,A=C(O)*D,m=S(O=2*Math.PI/n*J)*K+eo,O=Math.atan2(d=C(O)*K+c,u=0)+W,D=Math.hypot(d,u),d=S(O)*D,u=C(O)*D,O=Math.atan2(m,u)+2*Math.PI/p*ea+Math.PI/2,D=Math.hypot(m,u),T=S(O)*D,I=d,P=C(O)*D;var z=Math.atan2(h,g),V=Math.atan2(v,E),et=Math.atan2(b,A),ei=Math.atan2(T,P);Math.abs(z-et)>Math.PI&&(et+=2*Math.PI,ei+=2*Math.PI),F=(z+Math.PI)/Math.PI/2,L=_+.5,B=(V+Math.PI)/Math.PI/2,U=y+.5,N=(et+Math.PI)/Math.PI/2,w=x+.5,M=(ei+Math.PI)/Math.PI/2,k=I+.5,$=[...$,[[h,_,g],[v,y,E],[b,x,A],[T,I,P]]],f=[...f,[[F,L],[B,U],[N,w],[M,k]]]}return await GeometryFromRaw($,f,e/1.2,a,r,o,!0,t)},Tetrahedron=async(e=1,a=0,r=0,o=!1,t)=>{var i,n,s,c,l,$,f,p,m,d,u,h,_,g,v,y,E=1,b=[],x=[];g=[];let A=E/1.4142/1.25;for(u=3;u--;)i=S(c=2*Math.PI/3*u)*E/1.25,n=C(c)*E/1.25,g=[...g,[i,n,s=A]];for(h=3,x=[...x,g];h--;)g=[...g=[],[i=0,n=0,s=-A]],i=S(c=2*Math.PI/3*h)*E/1.25,n=C(c)*E/1.25,g=[...g,[i,n,s=A]],i=S(c=2*Math.PI/3*(h+1))*E/1.25,n=C(c)*E/1.25,x=[...x,g=[...g,[i,n,s=A]]];f=p=m=y=0,x.map(e=>{e.map(e=>{f+=e[0],p+=e[1],m+=e[2],y++})}),f/=y,p/=y,m/=y,x.map(e=>{e.map(e=>{e[0]-=f,e[1]-=p,e[2]-=m})});var T=x,I=[];for(u=0;u<T.length;u++){g=[];for(var P=T[u].length;P--;){switch(P){case 0:l=0,$=0;break;case 1:l=1,$=0;break;case 2:l=1,$=1;break;case 3:l=0,$=.5;break;case 4:l=0,$=1}g=[...g,[l,$]]}I=[...I,g]}return GeometryFromRaw(T,I,e,a,r,o,!1,t)},Octahedron=async(e=1,a=0,r=0,o=!1,t)=>{var i,n,s,c,l,$,f,p,m,d,u,h,_=1,g=[],v=[];let y=_/1.25;for(m=8;m--;)u=[...u=[],[i=0,n=0,s=y*(m<4?-1:1)]],i=S(c=2*Math.PI/4*m)*_/1.25,n=C(c)*_/1.25,u=[...u,[i,n,s=0]],i=S(c=2*Math.PI/4*(m+1))*_/1.25,n=C(c)*_/1.25,v=[...v,u=[...u,[i,n,s=0]]];var E=v,b=[];for(p=0;p<E.length;p++){u=[];for(var x=E[p].length;x--;){switch(x){case 0:l=0,$=0;break;case 1:l=1,$=0;break;case 2:l=1,$=1;break;case 3:l=0,$=.5;break;case 4:l=0,$=1}u=[...u,[l,$]]}b=[...b,u]}return await GeometryFromRaw(E,b,e,a,r,o,!1,t)},Icosahedron=async(e=1,a=0,r=0,o=!1,t)=>{var i,n,s,c,l,$,f,p,m,d,u,h,_,g,v,y,E,b,x,A,T,I,P,F=[],L=[];let B=[[[0,3],[1,0],[2,2]],[[0,3],[1,0],[1,3]],[[0,3],[2,3],[1,3]],[[0,2],[2,1],[1,0]],[[0,2],[1,3],[1,0]],[[0,2],[1,3],[2,0]],[[0,3],[2,2],[0,0]],[[1,0],[2,2],[2,1]],[[1,1],[2,2],[2,1]],[[1,1],[2,2],[0,0]],[[1,1],[2,1],[0,1]],[[0,2],[2,1],[0,1]],[[2,0],[1,2],[2,3]],[[0,0],[0,3],[2,3]],[[1,3],[2,0],[2,3]],[[2,3],[0,0],[1,2]],[[1,2],[2,0],[0,1]],[[0,0],[1,2],[1,1]],[[0,1],[1,2],[1,1]],[[0,2],[2,0],[0,1]],];for(_=3,y=[[-(v=.5+2.23606797749979/2),-1,0],[v,-1,0],[v,1,0],[-v,1,0],];_--;L=[...L,$])for($=[],i=4;i--;)$=[...$,[y[i][_],y[i][(_+1)%3],y[i][(_+2)%3]]];L.map(e=>{e.map(e=>{e[0]*=1/2.25,e[1]*=1/2.25,e[2]*=1/2.25})}),E=JSON.parse(JSON.stringify(L)),u=[],y=[],B.map(e=>{b=e[0][0],x=e[1][0],A=e[2][0],T=e[0][1],I=e[1][1],P=e[2][1],y=[...y,[E[b][T],E[x][I],E[A][P]]]});var U=u=[...u,...y],N=[];for(i=0;i<U.length;i++){y=[];for(var w=U[i].length;w--;){switch(w){case 0:m=0,d=0;break;case 1:m=1,d=0;break;case 2:m=1,d=1;break;case 3:m=0,d=.5;break;case 4:m=0,d=1}y=[...y,[m,d]]}N=[...N,y]}return await GeometryFromRaw(U,N,e,a,r,o,!1,t)},Dodecahedron=async(e=1,a=0,r=0,o=!1,t)=>{var i,n,s,c,l,$,f,p,m,d,u,h,_,g=[],v=[];let y=-6e6;for(i=5;i--;)n=S(f=2*Math.PI/5*i+Math.PI/5),s=C(f),c=0,s>y&&(y=s),v=[...v,[n,s,c]];v=v.map(e=>(n=e[0],R(n,s=e[1]-=y,c=e[2],{x:0,y:0,z:0,roll:0,pitch:.553573,yaw:0}))),($=structuredClone(v)).map(e=>{e[1]*=-1}),y=-6e6,(g=[...g,v,$]).map(e=>{e.map(e=>{n=e[0],s=e[1],(c=e[2])>y&&(y=c)})}),l=Math.hypot(g[0][0][0]-g[0][1][0],g[0][0][1]-g[0][1][1],g[0][0][2]-g[0][1][2]),g.map(e=>{e.map(e=>{e[2]-=y+l/2})}),($=structuredClone(g)).map(e=>{e.map(e=>{e[2]*=-1})}),($=structuredClone(g=[...g,...$])).map(e=>{e.map(e=>{n=e[0],p=R(n,s=e[1],c=e[2],{x:0,y:0,z:0,roll:0,pitch:0,yaw:Math.PI/2}),p=R(p[0],p[1],p[2],{x:0,y:0,z:0,roll:0,pitch:Math.PI/2,yaw:0}),e[0]=p[0],e[1]=p[1],e[2]=p[2]})}),(E=structuredClone(g)).map(e=>{e.map(e=>{n=e[0],p=R(n,s=e[1],c=e[2],{x:0,y:0,z:0,roll:0,pitch:0,yaw:Math.PI/2}),p=R(p[0],p[1],p[2],{x:0,y:0,z:0,roll:Math.PI/2,pitch:0,yaw:0}),e[0]=p[0],e[1]=p[1],e[2]=p[2]})});var E=g=[...g,...$,...E],b=[];for(i=0;i<E.length;i++){v=[];for(var x=E[i].length;x--;){switch(x){case 0:m=0,d=0;break;case 1:m=1,d=0;break;case 2:m=1,d=1;break;case 3:m=0,d=.5;break;case 4:m=0,d=1}v=[...v,[m,d]]}b=[...b,v]}return await GeometryFromRaw(E,b,e/Math.max(1,2-r),a,r,o,!1,t)},Cube=async(e=1,a=0,r=0,o=!1,t)=>{var i,n,s,c,l,$,f,p,m,d,u,h,_,g,v,y=Math.PI,E=[],b=[];for(l=6;l--;b=[...b,s])for(s=[],$=4;$--;)s=[...s,[(n=[S(i=2*y/4*$+y/4),C(i),1.4142135623730951/2])[l%3]*(c=l<3?1:-1),n[(l+1)%3]*c,n[(l+2)%3]*c]];var x=[];for(l=0;l<b.length;l++){n=[];for(var f=b[l].length;f--;){switch(f){case 0:p=0,m=0;break;case 1:p=1,m=0;break;case 2:p=1,m=1;break;case 3:p=0,m=1}n=[...n,[p,m]]}x=[...x,n]}return await GeometryFromRaw(b,x,e/1.2,a,r,o,!0,t)},Rectangle=async(e=1,a=0,r=0,o=!1,t)=>{var i,n,s,c,l,$,f,p,m,d,u,h,_,g,v,y,E=Math.PI,b=[],x=[];return await GeometryFromRaw(x=[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],]],[[[0,0],[1,0],[1,1],[0,1],]],e/1.5,Math.max("sprite"==t?1:2,a),r,o,!0,t)},IsPowerOf2=(e,a=0)=>!(a>300)&&(2==e||IsPowerOf2(e/2,a+1)),Normal=(e,a=!1,r=0,o=0,t=0)=>{var i,n,s=0,c=0,l=0;e.map(e=>{s+=e[0],c+=e[1],l+=e[2]}),s/=e.length,c/=e.length,l/=e.length;var $=e[2][0]-e[1][0],f=e[2][1]-e[1][1],p=e[2][2]-e[1][2],m=e[1][0]-e[0][0],d=e[1][1]-e[0][1],u=e[1][2]-e[0][2];n=Math.hypot(...i=[f*u-p*d,p*m-$*u,$*d-f*m])+1e-4;var h=1;i=i.map(e=>e/n*h);var _=s,g=c,v=l,y=1;if(a){var E,b=Math.hypot(_-r,g-o,v-t);y=Math.hypot(r-(s+i[0]/99),o-(c+i[1]/99),t-(l+i[2]/99))>b?-1:1}var x=s+(i[0]*=y),A=c+(i[1]*=y),T=l+(i[2]*=y);return[_,g,v,x,A,T]},AnimationLoop=(e,a)=>{let r=()=>{if(e.ready&&void 0!==window[a]&&window[a](),e.spriteQueue.length){var o,t=[];e.spriteQueue.map((a,r)=>{var i,n,s,c=a.x+e.x;o=R(c,a.y+e.y,a.z+e.z,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1),t=[...t,{idx:r,z:e.z/1e3*Math.pow(5,Math.log(e.fov)/1.609438)+o[2]}]}),t.sort((e,a)=>a.z-e.z),e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e.spriteQueue.map(async(a,r)=>{var o=e.spriteQueue[t[r].idx];o.disableDepthTest&&e.ctx.disable(e.ctx.DEPTH_TEST),await e.Draw(o,!0),o.disableDepthTest&&e.ctx.enable(e.ctx.DEPTH_TEST)}),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}e.t+=1/60,requestAnimationFrame(r),e.spriteQueue=[]};window.addEventListener("load",()=>{e.ready=!0,r()})},RGBToHSV=(e,a,r)=>HSVFromRGB(e,a,r),HSVFromRGB=(e,a,r)=>{let o=e/255,t=a/255,i=r/255,n=Math.min(o,t,i),s=Math.max(o,t,i),c=s,l=s-n,$=s?l/s:0,f=Math.min(e,a,r),p=Math.max(e,a,r),m=0;for(l&&(e>=a&&e>=r&&(m=(a-r)/(p-f)),a>=e&&a>=r&&(m=2+(r-e)/(p-f)),r>=a&&r>=e&&(m=4+(e-a)/(p-f))),m*=60;m<0;)m+=360;for(;m>=360;)m-=360;return[m,$,c]},HSVToHex=(e,a,r)=>HexFromHSV(e,a,r),HexFromHSV=(e,a,r)=>{let o=RGBFromHSV(e,a,r);return RGBToHex(...o)},HSVToRGB=(e,a,r)=>RGBFromHSV(e,a,r),RGBFromHSV=(e,a,r)=>{for(;e<0;)e+=360;for(;e>=360;)e-=360;let o=r*a,t=o*(1-Math.abs(e/60%2-1)),i=r-o,n,s,c;e>=0&&e<60&&(n=o,s=t,c=0),e>=60&&e<120&&(n=t,s=o,c=0),e>=120&&e<180&&(n=0,s=o,c=t),e>=180&&e<240&&(n=0,s=t,c=o),e>=240&&e<300&&(n=t,s=0,c=o),e>=300&&e<360&&(n=o,s=0,c=t);let l=(n+i)*255,$;return[l,(s+i)*255,(c+i)*255]},HexFromRGB=(e,a,r)=>RGBToHex(e,a,r),RGBToHex=(e,a,r)=>{let o="0123456789abcdef",t="";return t+=o[e/16|0],t+=o[e-(e/16|0)*16|0],t+=o[a/16|0],t+=o[a-(a/16|0)*16|0],t+=o[r/16|0],Number("0x"+(t+=o[r-(r/16|0)*16|0]))},RGBFromHex=e=>HexToRGB(e),HexToRGB=e=>{var a,r=e/256-(e/256|0),o=e/65536-(e/65536|0);return[e/16777216-(e/16777216|0),o,r]},getParams=e=>{var a,r=[];["COPY_READ_BUFFER_BINDING","COPY_WRITE_BUFFER_BINDING","DRAW_BUFFERi","DRAW_FRAMEBUFFER_BINDING","FRAGMENT_SHADER_DERIVATIVE_HINT","MAX_3D_TEXTURE_SIZE","MAX_ARRAY_TEXTURE_LAYERS","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","MAX_COLOR_ATTACHMENTS","MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS","MAX_COMBINED_UNIFORM_BLOCKS","MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS","MAX_DRAW_BUFFERS","MAX_ELEMENT_INDEX","MAX_ELEMENTS_INDICES","MAX_ELEMENTS_VERTICES","MAX_FRAGMENT_INPUT_COMPONENTS","MAX_FRAGMENT_UNIFORM_BLOCKS","MAX_FRAGMENT_UNIFORM_COMPONENTS","MAX_PROGRAM_TEXEL_OFFSET","MAX_SAMPLES","MAX_SERVER_WAIT_TIMEOUT","MAX_TEXTURE_LOD_BIAS","MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS","MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS","MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS","MAX_UNIFORM_BLOCK_SIZE","MAX_UNIFORM_BUFFER_BINDINGS","MAX_VARYING_COMPONENTS","MAX_VERTEX_OUTPUT_COMPONENTS","MAX_VERTEX_UNIFORM_BLOCKS","MAX_VERTEX_UNIFORM_COMPONENTS","MIN_PROGRAM_TEXEL_OFFSET","PACK_ROW_LENGTH","PACK_SKIP_PIXELS","PACK_SKIP_ROWS","PIXEL_PACK_BUFFER_BINDING","PIXEL_UNPACK_BUFFER_BINDING","RASTERIZER_DISCARD","READ_BUFFER","READ_FRAMEBUFFER_BINDING","SAMPLE_ALPHA_TO_COVERAGE","SAMPLE_COVERAGE","SAMPLER_BINDING","TEXTURE_BINDING_2D_ARRAY","TEXTURE_BINDING_3D","TRANSFORM_FEEDBACK_ACTIVE","TRANSFORM_FEEDBACK_BINDING","TRANSFORM_FEEDBACK_BUFFER_BINDING","TRANSFORM_FEEDBACK_PAUSED","UNIFORM_BUFFER_BINDING","UNIFORM_BUFFER_OFFSET_ALIGNMENT","UNPACK_IMAGE_HEIGHT","UNPACK_ROW_LENGTH","UNPACK_SKIP_IMAGES","UNPACK_SKIP_PIXELS","UNPACK_SKIP_ROWS","VERTEX_ARRAY_BINDING"].map(a=>{r.push({name:a,val:e.getParameter(e[a])})});var o=document.createElement("div");o.style.position="fixed",o.style.zIndex=1e5,o.style.left="50%",o.style.top="50%",o.style.transform="translate(-50%, -50%)",o.style.background="#0008",o.style.padding="20px",o.style.width="600px",o.style.height="350px",o.style.border="1px solid #fff4",o.style.borderRadius="5px",o.style.fontFamily="monospace",o.style.fontSize="20px",o.style.color="#fff";var t=document.createElement("div");t.style.fontSize="24px",t.style.color="#0f8c",t.innerHTML="rendering context parameters<br><br>",o.appendChild(t);var i=document.createElement("div");i.style.minWidth="100%",i.style.height="250px",i.style.background="#333",i.style.border="1px solid #fff4",i.style.overflowY="auto",i.style.wordWrap="break-word",i.style.color="#888",i.style.fontSize="10px",o.appendChild(i);var n=document.createElement("button");n.style.border="none",n.style.padding="3px",n.style.cursor="pointer",n.fontSize="20px",n.style.borderRadius="10px",n.style.margin="10px",n.style.minWidth="100px",n.innerHTML="\uD83D\uDCCB copy",n.title="copy shape data to clipboard",n.onclick=()=>{var e=document.createRange();e.selectNode(i),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),n.innerHTML="COPIED!",setTimeout(()=>{n.innerHTML="\uD83D\uDCCB copy"},1e3)},o.appendChild(n);var s=document.createElement("button");s.onclick=()=>o.remove(),s.style.border="none",s.style.padding="3px",s.style.cursor="pointer",s.fontSize="20px",s.style.borderRadius="10px",s.style.margin="10px",s.style.background="#faa",s.style.minWidth="100px",s.innerHTML="close",o.appendChild(s),i.innerHTML=JSON.stringify(r),document.body.appendChild(o)};export{Renderer,LoadGeometry,BasicShader,DestroyViewport,AnimationLoop,Tetrahedron,Cube,Octahedron,Icosahedron,Dodecahedron,Cylinder,Torus,TorusKnot,Rectangle,Q,R,Normal,ImageToPo2,LoadOBJ,IsPowerOf2,RGBToHSV,HSVToHex,HexFromHSV,HSVToRGB,RGBFromHSV,HexFromRGB,RGBToHex,RGBFromHex,HexToRGB,GeoSphere};