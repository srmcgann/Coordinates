<!DOCTYPE html>
<html>
  <head>
    <style>
      body, html{
        background: #000;
        margin: 0;
        min-height: 100vh;
        color: #fff;
        font-family: monospace;
        font-size: 20px;
      }
    </style>
  </head>
  <body>
    <div id="output"></div>
    <script type="module">
      import * as Coordinates from "./coordinates.js"
      
      var [c, gl] = Coordinates.CreateViewport(1920, 1080)//, ['2d'])
      var loop   = Coordinates.AnimationLoop('Draw')


      var vert =`
        #version 100
        void main() {
          gl_Position = vec4(0.0, 0.0, 0.0, 1.0);
          gl_PointSize = 64.0;
        }
        //varying vec2 vUv;
        //void main() {
          //vUv = uv;
        //  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        //}
        `
      
      var frag = `
        #version 100
        void main() {
          gl_FragColor = vec4(0.18, 0.54, 0.34, 1.0);
        }
        //varying vec2 vUv;
        //uniform sampler2d baseTexture;
        //void main() {
        //  vec4 texel = vec4(1.0, 0.0, 0.0, 1.0);//texture2D( baseTexture, vUv );
        //  gl_FragColor = texel; //vec4(0.18, 0.54, 0.34, 1.0);
        //}
        `
        

      var cube = Coordinates.Cube(6, 2)
      var cubeGeometry = Coordinates.Geometry(cube)
            
      const vertices = cubeGeometry

      // Create array buffer
      const buffer = new ArrayBuffer(20 * vertices.length);
      // Fill array buffer
      const dv = new DataView(buffer);
      console.log(buffer)
      console.log(vertices)
      vertices.forEach((vertex, i) => {
        dv.setFloat32(20 * i, vertex.position[0], true);
        dv.setFloat32(20 * i + 4, vertex.position[1], true);
        dv.setFloat32(20 * i + 8, vertex.position[2], true);
        dv.setInt8(20 * i + 12, vertex.normal[0] * 0x7f);
        dv.setInt8(20 * i + 13, vertex.normal[1] * 0x7f);
        dv.setInt8(20 * i + 14, vertex.normal[2] * 0x7f);
        dv.setInt8(20 * i + 15, 0);
        dv.setUint16(20 * i + 16, vertex.texCoord[0] * 0xffff, true);
        dv.setUint16(20 * i + 18, vertex.texCoord[1] * 0xffff, true);
      })

      const vertexShader = gl.createShader(gl.VERTEX_SHADER)
      gl.shaderSource(vertexShader, vert)
      gl.compileShader(vertexShader)
      
      const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER)
      gl.shaderSource(fragmentShader, frag)
      gl.compileShader(fragmentShader)
      
      var program = gl.createProgram()
      gl.attachShader(program, vertexShader)
      gl.attachShader(program, fragmentShader)
      gl.linkProgram(program)
      //gl.detachShader(program, vertexShader)
      //gl.detachShader(program, fragmentShader)
      //gl.deleteShader(vertexShader)
      //gl.deleteShader(fragmentShader)
      if (gl.getProgramParameter(program, gl.LINK_STATUS)) {
        gl.useProgram(program)
        
        //initialize attributes
        gl.enableVertexAttribArray(0)
        gl.enableVertexAttribArray(1)
        gl.enableVertexAttribArray(2)
        gl.enableVertexAttribArray(4)
        
        let vbo = gl.createBuffer()
        gl.bindBuffer(gl.ARRAY_BUFFER, vbo)
        gl.bufferData(gl.ARRAY_BUFFER, buffer, gl.STATIC_DRAW)
        
        /*
        //Describe the layout of the buffer:
        //1. position, not normalized
        gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 20, 0);
        gl.enableVertexAttribArray(0);
        //2. normal vector, normalized to [-1, 1]
        gl.vertexAttribPointer(1, 4, gl.BYTE, true, 20, 12);
        gl.enableVertexAttribArray(1);
        //3. texture coordinates, normalized to [0, 1]
        gl.vertexAttribPointer(2, 2, gl.UNSIGNED_SHORT, true, 20, 16);
        gl.enableVertexAttribArray(2);

        //Set the attributes in the vertex shader to the same indices
        gl.bindAttribLocation(program, 0, "position");
        gl.bindAttribLocation(program, 1, "normal");
        gl.bindAttribLocation(program, 2, "texUV");
        //Since the attribute indices have changed, we must re-link the shader
        //Note that this will reset all uniforms that were previously set.
        gl.linkProgram(program)
        */
        
        
        const locPosition = gl.getAttribLocation(program, "position")
        gl.vertexAttribPointer(locPosition, 3, gl.FLOAT, false, 20, 0)
        gl.enableVertexAttribArray(locPosition)
        
        //const locNormal = gl.getAttribLocation(program, "normal")
        //gl.vertexAttribPointer(locNormal, 4, gl.BYTE, true, 20, 12)
        //gl.enableVertexAttribArray(locNormal)
        
        const locTexUV = gl.getAttribLocation(program, "uv")
        gl.vertexAttribPointer(locTexUV, 2, gl.UNSIGNED_SHORT, true, 20, 16)
        gl.enableVertexAttribArray(locTexUV)
        
        
        //gl.vertexAttribPointer(0, 1, gl.FLOAT, false, 0, 0);

        gl.useProgram(program);
        gl.drawArrays(gl.POINTS, 0, 1);
  
      }else{
        console.log(`bad shader :(`)
        console.log(gl.getProgramInfoLog(program))
      }

      
      var t = 0
      
      var oX, oY, oZ, Rl, Pt, Yw, X, Y, Z
      var S = Math.sin, C = Math.cos
      
      window.Draw = () => {

        /*
        
        Coordinates.Clear(c)

        oX = 0
        oY = 0
        oZ = 16
        Rl = 0
        Pt = t/2
        Yw = t

        cube.map(v=>{
          x.beginPath()
          v.map(q=>{
            X = q[0]
            Y = q[1]
            Z = q[2]
            var e = Coordinates.R(X,Y,Z, oX,oY,oZ, Rl,Pt,Yw, true)
            X = e[0]
            Y = e[1]
            Z = e[2]
            if(Z>0) x.lineTo(...Coordinates.Q(X, Y, Z, c))
          })
          x.lineWidth = 50/Z
          x.strokeStyle = `#f004`
          x.fillStyle = `#f001`
          x.stroke()
          x.strokeStyle = `#f008`
          x.lineWidth /= 4
          x.stroke()
          x.fill()
        })
        */
        t += 1/60
      }
      
    </script>
  </body>
</html>

